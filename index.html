<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Farm Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-image: url('expansion_20251026011142619.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      overflow-x: hidden;
    }

    .overlay {
      background-color: rgba(0,0,0,0.35);
      backdrop-filter: blur(3px);
      min-height: 100vh;
      padding-left: 240px;
    }

    .sidebar {
      height: 100vh;
      background-color: rgba(47, 93, 47, 0.9);
      color: white;
      padding: 20px;
      position: fixed;
      width: 220px;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      margin: 15px 0;
      transition: color 0.3s ease;
    }

    .sidebar a:hover { color: #a8e063; }

    .main-content { padding: 20px; }

    .navbar { background-color: rgba(86, 171, 47, 0.9); border-radius: 10px; }
    .navbar-brand { color: white; font-weight: bold; }

    .card {
      margin-bottom: 20px;
      background-color: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(2px);
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.3);
    }

    .highlight { color: #2e7d32; font-weight: 600; }
    .profit-positive { color: green; font-weight: bold; }
    .profit-negative { color: red; font-weight: bold; }

    @media(max-width: 768px){
      .overlay { padding-left: 0; }
      .sidebar { width: 100%; height: auto; position: relative; flex-direction: row; justify-content: space-around; }
      .main-content { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="sidebar">
      <h4>Farm Dashboard</h4>
      <a href="cropManagement.html">Crop Management</a>
      <a href="livesk.html">Livestock Tracking</a>
      <a href="inventory.html">Equipment & Inventory</a>
      <a href="finance.html">Financial Reports</a>
      <a href="settings.html">Settings</a>
    </div>

    <div class="main-content">
      <nav class="navbar navbar-expand-lg mb-4">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Welcome, Farmer</a>
        </div>
      </nav>

      <h3 class="text-white mb-4">Farm Overview</h3>
      <div class="row">
        <!-- Crop Management -->
        <div class="col-md-4">
          <div class="card border-success">
            <div class="card-header bg-success text-white">Crop Management</div>
            <div class="card-body">
              <p>ğŸŒ± Total Crops: <span id="totalCrops" class="highlight">0</span></p>
              <p>ğŸ’§ Irrigation: <span id="irrigationPercent" class="highlight">0%</span></p>
              <p>ğŸª² Pest Alerts: <span id="pestAlerts" class="highlight">0</span></p>
              <canvas id="cropChart" height="100"></canvas>
              <a href="cropManagement.html" class="btn btn-success mt-2">View Details</a>
            </div>
          </div>
        </div>

        <!-- Livestock Tracking -->
        <div class="col-md-4">
          <div class="card border-warning">
            <div class="card-header bg-warning text-dark">Livestock Tracking</div>
            <div class="card-body">
              <p>ğŸ„ Cattle: <span id="totalCattle" class="highlight">0</span></p>
              <p>ğŸ Goats: <span id="totalGoats" class="highlight">0</span></p>
              <p>ğŸ©º Health Checks: <span id="healthPercent" class="highlight">0%</span></p>
              <canvas id="livestockChart" height="100"></canvas>
              <a href="livesk.html" class="btn btn-warning mt-2">View Details</a>
            </div>
          </div>
        </div>

        <!-- Inventory -->
        <div class="col-md-4">
          <div class="card border-info">
            <div class="card-header bg-info text-white">Inventory</div>
            <div class="card-body">
              <p>ğŸšœ Tractors: <span id="tractors" class="highlight">0</span></p>
              <p>ğŸ§ª Fertilizer: <span id="fertilizer" class="highlight">0%</span></p>
              <p>ğŸŒ¾ Seeds: <span id="seeds" class="highlight">0%</span></p>
              <canvas id="inventoryChart" height="100"></canvas>
              <a href="inventory.html" class="btn btn-info mt-2">Manage Inventory</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Financial & Settings -->
      <div class="row">
        <div class="col-md-6">
          <div class="card border-dark">
            <div class="card-header bg-dark text-white">Financial Summary</div>
            <div class="card-body">
              <p>ğŸ’° Monthly Income: à§³<span id="income" class="highlight">0</span></p>
              <p>ğŸ“‰ Monthly Expenses: à§³<span id="expenses" class="highlight">0</span></p>
              <p>ğŸ“ˆ Net Profit: <span id="netProfit" class="profit-positive">0</span></p>
              <canvas id="financeChart" height="100"></canvas>
              <a href="finance.html" class="btn btn-dark mt-2">View Detailed Report</a>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">Settings</div>
            <div class="card-body">
              <p>ğŸ‘¤ Profile: <span class="highlight">Farmer Ethun</span></p>
              <p>ğŸ”” Notifications: <span class="highlight">Enabled</span></p>
              <p>ğŸŒ Language: <span class="highlight">English</span></p>
              <p>ğŸ› ï¸ System Mode: <span class="highlight">Standard</span></p>
              <button id="logoutBtn" class="btn btn-danger mt-2">Logout</button>
              <a href="settings.html" class="btn btn-primary mt-2">Manage Settings</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    async function fetchDashboardData() {
      const token = localStorage.getItem('token');
      if (!token) { 
        alert('Login required'); 
        window.location.href = 'login.html'; 
        return; 
      }
  
      const headers = { 'Authorization': `Bearer ${token}` };
  
      // ===== Fetch Crops =====
      try {
        const res = await fetch(`${BASE_URL}/crops`, { headers });
        if (!res.ok) throw new Error('Failed to fetch crops');
        const crops = await res.json();
  
        document.getElementById('totalCrops').innerText = crops.length;
        document.getElementById('irrigationPercent').innerText = '80%';
        document.getElementById('pestAlerts').innerText = '2';
  
        const cropTypes = { Planting:0, Irrigation:0, Harvest:0 };
        crops.forEach(c => { if(cropTypes[c.activity] !== undefined) cropTypes[c.activity]++; });
  
        new Chart(document.getElementById('cropChart'), {
          type: 'bar',
          data: {
            labels: ['Planting','Irrigation','Harvest'],
            datasets: [{ label:'Activities', data: Object.values(cropTypes), backgroundColor:'#2e7d32' }]
          }
        });
      } catch(err) { console.error(err); }
  
      // ===== Fetch Livestock =====
      try {
        const res = await fetch(`${BASE_URL}/livestock`, { headers });
        if (!res.ok) throw new Error('Failed to fetch livestock');
        const livestock = await res.json();
  
        const totalCattle = livestock.filter(l => l.type==='Cattle').length;
        const totalGoats = livestock.filter(l => l.type==='Goat').length;
  
        document.getElementById('totalCattle').innerText = totalCattle;
        document.getElementById('totalGoats').innerText = totalGoats;
        document.getElementById('healthPercent').innerText = '90%';
  
        new Chart(document.getElementById('livestockChart'), {
          type: 'pie',
          data: {
            labels: ['Cattle','Goats'],
            datasets: [{
              data: [totalCattle, totalGoats],
              backgroundColor: ['#ffc107','#fd7e14']
            }]
          }
        });
      } catch(err) { console.error(err); }
  
      // ===== Fetch Inventory =====
      try {
        const res = await fetch(`${BASE_URL}/inventory`, { headers });
        if (!res.ok) throw new Error('Failed to fetch inventory');
        const inventory = await res.json();
  
        document.getElementById('tractors').innerText = inventory.filter(i => i.item==='Tractor').length;
        document.getElementById('fertilizer').innerText = '60%';
        document.getElementById('seeds').innerText = '40%';
  
        new Chart(document.getElementById('inventoryChart'), {
          type: 'bar',
          data: {
            labels: inventory.map(i => i.item),
            datasets: [{
              label: 'Quantity',
              data: inventory.map(i => i.quantity),
              backgroundColor: '#17a2b8'
            }]
          }
        });
      } catch(err) { console.error(err); }
  
      // ===== Fetch Finance =====
      try {
        const res = await fetch(`${BASE_URL}/finance`, { headers });
        if (!res.ok) throw new Error('Failed to fetch finance');
        const finances = await res.json();
  
        const income = finances.filter(f => f.type==='Income').reduce((a,b)=>a+b.amount,0);
        const expenses = finances.filter(f => f.type==='Expense').reduce((a,b)=>a+b.amount,0);
        const netProfit = income - expenses;
  
        document.getElementById('income').innerText = income;
        document.getElementById('expenses').innerText = expenses;
        document.getElementById('netProfit').innerText = netProfit;
  
        new Chart(document.getElementById('financeChart'), {
          type: 'pie',
          data: {
            labels: ['Income','Expenses'],
            datasets: [{
              data: [income, expenses],
              backgroundColor: ['#28a745','#dc3545']
            }]
          }
        });
      } catch(err) { console.error(err); }
    }
  
    // ===== Logout =====
    const logoutBtn = document.getElementById('logoutBtn');
    if(logoutBtn){
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      });
    }
  
    // ===== Initial Load =====
    fetchDashboardData();
  </script>
  

</body>
</html>
